<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#006633">
    <title>SYSU Chat - 中山大学在线聊天室</title>
    <meta name="description" content="SYSU Chat - 中山大学学生在线聊天交流平台">
    <meta name="keywords" content="中山大学, 聊天室, SYSU, 在线交流">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="apple-touch-icon" href="apple-touch-icon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.svg">
    <link rel="manifest" href="manifest.json">
    <!-- iOS PWA 优化 -->
    <meta name="apple-mobile-web-app-title" content="SYSU Chat">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Lucide Icons (本地) -->
    <script src="js/lucide.min.js"></script>
    <link rel="stylesheet" href="css/style.css?v=11">
</head>
<body>
    <div class="app-container">
        <!-- 侧边栏遮罩（移动端） -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        
        <!-- Sidebar (用户列表) -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">
                    <i data-lucide="graduation-cap"></i>
                    SYSU Chat
                </div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-section-header">
                    <span class="online-count" id="onlineCount">在线: --</span>
                </div>
            </div>
            <div class="user-list" id="userList">
                <!-- 用户列表将通过 JS 动态渲染 -->
            </div>
            <div class="sidebar-footer">
                <button class="btn btn-outline btn-sm" id="filesBtn" title="打开网盘">
                    <i data-lucide="hard-drive"></i>
                    群文件
                </button>
                <button class="btn btn-outline btn-sm" id="logoutBtn">
                    <i data-lucide="log-out"></i>
                    退出登录
                </button>
            </div>
        </aside>

        <!-- 主聊天区域 -->
        <main class="chat-area">
            <header class="chat-header">
                <div class="chat-header-info">
                    <div class="chat-status">
                        <span class="status-dot" id="statusDot"></span>
                        <span class="status-text" id="statusText">连接中...</span>
                    </div>
                </div>
                <div class="chat-header-actions">
                    <div class="theme-btn-wrapper">
                        <button class="icon-btn" id="themeBtn" title="切换主题">
                            <i data-lucide="palette"></i>
                        </button>
                        <div class="theme-panel" id="themePanel">
                            <div class="theme-option" data-theme="default">
                                <div class="theme-color" style="background-color: #006633;"></div>
                                SYSU Green
                            </div>
                            <div class="theme-option" data-theme="ocean">
                                <div class="theme-color" style="background-color: #0077cc;"></div>
                                Ocean Blue
                            </div>
                            <div class="theme-option" data-theme="purple">
                                <div class="theme-color" style="background-color: #722ed1;"></div>
                                Elegant Purple
                            </div>
                            <div class="theme-option" data-theme="sunset">
                                <div class="theme-color" style="background-color: #fa541c;"></div>
                                Warm Sunset
                            </div>
                        </div>
                    </div>
                    <button class="icon-btn" id="menuBtn" title="菜单">
                        <i data-lucide="menu"></i>
                    </button>
                </div>
            </header>

            <div class="messages-container" id="messagesContainer">
                <div class="welcome-message">
                    <p>👋 欢迎使用 <span id="welcomeRoomName">SYSU Chat</span>！</p>
                    <p>请登录后开始聊天~</p>
                </div>
            </div>

            <!-- @提及用户列表弹窗 -->
            <div class="mention-popup hidden" id="mentionPopup">
                <div class="mention-list" id="mentionList"></div>
            </div>

            <div class="input-area">
                <!-- 表情选择器弹窗 (移动到input-area内部以正确定位) -->
                <div class="emoji-popup hidden" id="emojiPopup">
                    <div class="emoji-header">
                        <div class="emoji-tabs">
                            <button class="emoji-tab active" data-tab="emoji">😊 表情</button>
                            <button class="emoji-tab" data-tab="sticker">🎨 表情包</button>
                        </div>
                        <button class="emoji-close" id="emojiClose">&times;</button>
                    </div>
                    <div class="emoji-content">
                        <div class="emoji-panel active" id="emojiPanel">
                            <div class="emoji-list" id="emojiList"></div>
                        </div>
                        <div class="emoji-panel" id="stickerPanel">
                            <div class="sticker-upload">
                                <button type="button" class="btn btn-outline btn-sm" id="uploadStickerBtn">
                                    ➕ 上传表情包
                                </button>
                                <input type="file" id="stickerInput" accept="image/*" multiple style="display:none">
                            </div>
                            <div class="sticker-list" id="stickerList">
                                <div class="sticker-empty">暂无自定义表情包<br>点击上方按钮上传</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <form id="messageForm" class="message-form">
                    <button type="button" class="icon-btn" id="emojiBtn" title="表情">
                        <i data-lucide="smile"></i>
                        <span class="icon-fallback">😊</span>
                    </button>
                    <button type="button" class="icon-btn" id="imageBtn" title="发送图片">
                        <i data-lucide="image"></i>
                        <span class="icon-fallback">🖼️</span>
                    </button>
                    <button type="button" class="icon-btn" id="fileBtn" title="发送文件">
                        <i data-lucide="paperclip"></i>
                        <span class="icon-fallback">📎</span>
                    </button>
                    
                    <div class="input-wrapper">
                        <input 
                            type="text" 
                            id="messageInput"
                            class="chat-input" 
                            placeholder="输入消息... (输入@提及用户，按 Enter 发送)"
                            maxlength="500"
                            autocomplete="off"
                        >
                    </div>

                    <button type="submit" class="send-btn">
                        <i data-lucide="send"></i>
                        <span class="icon-fallback">➤</span>
                    </button>
                </form>
                <!-- 隐藏的文件输入 -->
                <input type="file" id="imageInput" accept="image/*" style="display:none">
                <input type="file" id="fileInput" style="display:none">
                <!-- 上传进度显示 -->
                <div class="upload-progress hidden" id="uploadProgress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <span class="progress-text" id="progressText">上传中...</span>
                </div>
            </div>
        </main>

        <!-- 网盘面板 -->
        <aside class="files-panel hidden" id="filesPanel">
            <header class="files-header">
                <div class="files-header-info">
                    <i data-lucide="hard-drive"></i>
                    <h3>群文件</h3>
                </div>
                <div class="files-header-actions">
                    <button class="icon-btn" id="filesPanelRefresh" title="刷新">
                        <i data-lucide="refresh-cw"></i>
                    </button>
                    <button class="icon-btn" id="filesPanelClose" title="关闭">
                        <i data-lucide="x"></i>
                    </button>
                </div>
            </header>
            
            <!-- 存储空间 -->
            <div class="files-storage">
                <div class="storage-info">
                    <span class="storage-label">存储空间</span>
                    <span class="storage-value" id="filesPanelStorageText">计算中...</span>
                </div>
                <div class="storage-bar">
                    <div class="storage-fill" id="filesPanelStorageBar" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- 工具栏 -->
            <div class="files-toolbar">
                <div class="files-breadcrumb" id="filesPanelBreadcrumb">
                    <a href="#" class="breadcrumb-item active" data-path="/">
                        <i data-lucide="home"></i>
                    </a>
                </div>
                <div class="files-actions">
                    <button class="btn btn-sm btn-primary" id="filesPanelUpload" title="上传文件">
                        <i data-lucide="upload"></i>
                        上传
                    </button>
                    <button class="btn btn-sm btn-outline" id="filesPanelNewFolder" title="新建文件夹">
                        <i data-lucide="folder-plus"></i>
                    </button>
                </div>
            </div>
            
            <!-- 搜索框 -->
            <div class="files-search">
                <i data-lucide="search" class="search-icon"></i>
                <input type="text" id="filesPanelSearch" class="search-input" placeholder="搜索文件...">
            </div>
            
            <!-- 文件列表 -->
            <div class="files-content">
                <div class="files-loading" id="filesPanelLoading">
                    <i data-lucide="loader" class="spin"></i>
                    <p>加载中...</p>
                </div>
                <div class="files-list" id="filesPanelList">
                    <!-- 文件列表通过 JS 动态渲染 -->
                </div>
                <div class="files-empty hidden" id="filesPanelEmpty">
                    <i data-lucide="folder-open"></i>
                    <p>文件夹为空</p>
                    <p class="text-muted">拖拽文件到此处上传</p>
                </div>
            </div>
            
            <!-- 上传区域 (拖拽) -->
            <div class="files-drop-zone hidden" id="filesPanelDropZone">
                <i data-lucide="cloud-upload"></i>
                <p>释放以上传文件</p>
            </div>
            
            <!-- 隐藏的文件输入 -->
            <input type="file" id="filesPanelFileInput" multiple style="display:none">
        </aside>

        <!-- 网盘上传弹窗 -->
        <div class="files-upload-modal hidden" id="filesUploadModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>上传文件</h3>
                    <button class="btn-close" id="filesUploadModalClose">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="upload-area" id="filesUploadArea">
                        <i data-lucide="cloud-upload"></i>
                        <p>点击或拖拽文件到此处</p>
                    </div>
                    <div class="upload-list" id="filesUploadList"></div>
                </div>
            </div>
        </div>

        <!-- 新建文件夹弹窗 -->
        <div class="files-folder-modal hidden" id="filesFolderModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>新建文件夹</h3>
                    <button class="btn-close" id="filesFolderModalClose">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="filesFolderName">文件夹名称</label>
                        <input type="text" id="filesFolderName" class="form-input" placeholder="输入文件夹名称">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" id="filesFolderCancel">取消</button>
                    <button class="btn btn-primary" id="filesFolderCreate">创建</button>
                </div>
            </div>
        </div>

        <!-- 文件右键菜单 -->
        <div class="files-context-menu hidden" id="filesContextMenu">
            <div class="menu-item" data-action="download">
                <i data-lucide="download"></i> 下载
            </div>
            <div class="menu-item" data-action="rename">
                <i data-lucide="edit-2"></i> 重命名
            </div>
            <div class="menu-item danger" data-action="delete">
                <i data-lucide="trash-2"></i> 删除
            </div>
        </div>

        <!-- 登录覆盖层（默认隐藏，JS检测无token时显示） -->
        <div class="login-overlay hidden" id="loginPanel">
            <div class="login-card">
                <div class="login-header">
                    <img src="images/logo.svg" alt="SYSU Chat" class="login-logo">
                    <h1>SYSU Chat</h1>
                    <p>博学 审问 慎思 明辨 笃行</p>
                </div>
                
                <!-- 登录表单 -->
                <form id="loginForm" class="login-form">
                    <div class="form-group">
                        <label class="form-label" for="loginUsername">用户名</label>
                        <input 
                            type="text" 
                            id="loginUsername"
                            class="form-input" 
                            name="username" 
                            placeholder="请输入用户名"
                            maxlength="20"
                            minlength="3"
                            required
                            autocomplete="username"
                        >
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="loginPassword">密码</label>
                        <input 
                            type="password" 
                            id="loginPassword"
                            class="form-input" 
                            name="password" 
                            placeholder="请输入密码"
                            minlength="6"
                            required
                            autocomplete="current-password"
                        >
                    </div>
                        <div class="form-group">
                            <label class="form-label" for="loginRoomKey">群聊秘钥</label>
                            <input 
                                type="password" 
                                id="loginRoomKey"
                                class="form-input" 
                                name="roomKey" 
                                placeholder="请输入群聊秘钥"
                                required
                                autocomplete="off"
                            >
                            <small class="form-hint">请输入您注册时使用的秘钥</small>
                        </div>
                    <button type="submit" class="btn-primary">
                        登录
                    </button>
                </form>
                
                <!-- 注册表单 (默认隐藏) -->
                <form id="registerForm" class="login-form hidden">
                    <div class="form-group">
                        <label class="form-label" for="regUsername">用户名</label>
                        <input 
                            type="text" 
                            id="regUsername"
                            class="form-input" 
                            name="username" 
                            placeholder="3-20个字符"
                            maxlength="20"
                            minlength="3"
                            required
                            autocomplete="username"
                        >
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="regPassword">密码</label>
                        <input 
                            type="password" 
                            id="regPassword"
                            class="form-input" 
                            name="password" 
                            placeholder="至少6个字符"
                            minlength="6"
                            required
                            autocomplete="new-password"
                        >
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="regNickname">昵称</label>
                        <input 
                            type="text" 
                            id="regNickname"
                            class="form-input" 
                            name="nickname" 
                            placeholder="2-20个字符（聊天室显示名）"
                            maxlength="20"
                            minlength="2"
                            required
                            autocomplete="off"
                        >
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="regSecretKey">注册秘钥</label>
                        <input 
                            type="password" 
                            id="regSecretKey"
                            class="form-input" 
                            name="secretKey" 
                            placeholder="请输入内部通行密钥"
                            required
                            autocomplete="off"
                        >
                        <small class="form-hint">仅限内部成员使用</small>
                    </div>
                    <button type="submit" class="btn-primary">
                        注册
                    </button>
                </form>
                
                <div class="login-switch">
                    <span id="switchToRegister">没有账号？<a href="#" id="switchToRegisterLink">立即注册</a></span>
                    <span id="switchToLogin" class="hidden">已有账号？<a href="#" id="switchToLoginLink">立即登录</a></span>
                </div>
                
                <div class="login-footer">
                    <p>💡 提示：请文明聊天，遵守社区规范</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 关于弹窗 -->
    <div class="modal hidden" id="aboutModal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <button class="modal-close" id="closeAbout">&times;</button>
            <h2>关于 SYSU Chat</h2>
            <p>SYSU Chat 是一个简洁、高效的在线聊天平台，专为中山大学学生打造。</p>
            <h3>特点</h3>
            <ul>
                <li>🚀 实时消息推送</li>
                <li>🎨 简洁现代的界面</li>
                <li>📱 支持移动端访问</li>
                <li>🔒 安全可靠</li>
            </ul>
            <h3>技术栈</h3>
            <p>后端：Java + HTTP Server + SSE</p>
            <p>前端：HTML5 + CSS3 + JavaScript</p>
        </div>
    </div>

    <script src="js/config.js?v=6"></script>
    <script src="js/chat.js?v=25"></script>
    <script src="js/files-embed.js?v=2"></script>
    <script>
        // 初始化 Lucide 图标
        lucide.createIcons();
        
        // 注意：移动端菜单切换已在 chat.js 中的 initMobileSidebar() 处理
        // 这里不再重复绑定事件，避免冲突
    </script>
</body>
</html>
