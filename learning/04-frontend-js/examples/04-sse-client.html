<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>SSE å®¢æˆ·ç«¯å­¦ä¹ </title>
    <style>
        body { font-family: Arial; padding: 20px; max-width: 800px; margin: 0 auto; }
        h1 { color: #006633; }
        .demo-box { border: 2px solid #ddd; padding: 20px; margin: 20px 0; border-radius: 8px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #006633; color: white; border: none; border-radius: 4px; }
        button:hover { background: #004d26; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .code { background: #f0f0f0; padding: 15px; font-family: monospace; margin: 10px 0; border-radius: 4px; white-space: pre-wrap; }
        #messages { 
            background: #f5f5f5; 
            padding: 15px; 
            height: 200px; 
            overflow-y: auto; 
            border-radius: 4px;
            font-family: monospace;
        }
        .msg { padding: 5px 0; border-bottom: 1px solid #ddd; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .connecting { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>ğŸ“¡ SSE å®¢æˆ·ç«¯ (EventSource)</h1>
    <p>å­¦ä¹ å¦‚ä½•ç”¨ JavaScript æ¥æ”¶æœåŠ¡å™¨æ¨é€çš„æ¶ˆæ¯ã€‚</p>
    
    <!-- æ ¸å¿ƒä»£ç å±•ç¤º -->
    <div class="demo-box">
        <h3>æ ¸å¿ƒä»£ç </h3>
        <div class="code">// åˆ›å»º SSE è¿æ¥
const eventSource = new EventSource('/events');

// è¿æ¥æˆåŠŸ
eventSource.onopen = function() {
    console.log('å·²è¿æ¥');
};

// æ¥æ”¶æ¶ˆæ¯
eventSource.onmessage = function(event) {
    console.log('æ”¶åˆ°:', event.data);
};

// è¿æ¥é”™è¯¯
eventSource.onerror = function() {
    console.log('è¿æ¥æ–­å¼€ï¼Œå°†è‡ªåŠ¨é‡è¿...');
};

// å…³é—­è¿æ¥
eventSource.close();</div>
    </div>
    
    <!-- å®é™…æ¼”ç¤º -->
    <div class="demo-box">
        <h3>ğŸ”´ å®æ—¶æ¼”ç¤º</h3>
        <p>å…ˆè¿è¡Œ <code>ChatSSEServer.java</code> æˆ– <code>SimpleSSEServer.java</code></p>
        
        <div>
            <label>æœåŠ¡å™¨åœ°å€:</label>
            <input type="text" id="serverUrl" value="http://localhost:8080/events" style="width: 300px; padding: 8px;">
        </div>
        <br>
        
        <button id="connectBtn" onclick="connect()">è¿æ¥</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>æ–­å¼€</button>
        
        <div id="status" class="status disconnected">æœªè¿æ¥</div>
        
        <h4>æ¥æ”¶åˆ°çš„æ¶ˆæ¯:</h4>
        <div id="messages"></div>
        <button onclick="clearMessages()">æ¸…ç©ºæ¶ˆæ¯</button>
    </div>
    
    <!-- EventSource çŠ¶æ€è¯´æ˜ -->
    <div class="demo-box">
        <h3>EventSource çŠ¶æ€ç </h3>
        <table border="1" style="border-collapse: collapse; width: 100%;">
            <tr style="background: #f5f5f5;">
                <th style="padding: 10px;">çŠ¶æ€</th>
                <th style="padding: 10px;">å€¼</th>
                <th style="padding: 10px;">è¯´æ˜</th>
            </tr>
            <tr>
                <td style="padding: 10px;">CONNECTING</td>
                <td style="padding: 10px;">0</td>
                <td style="padding: 10px;">æ­£åœ¨è¿æ¥</td>
            </tr>
            <tr>
                <td style="padding: 10px;">OPEN</td>
                <td style="padding: 10px;">1</td>
                <td style="padding: 10px;">å·²è¿æ¥</td>
            </tr>
            <tr>
                <td style="padding: 10px;">CLOSED</td>
                <td style="padding: 10px;">2</td>
                <td style="padding: 10px;">å·²å…³é—­</td>
            </tr>
        </table>
        <p id="currentState"></p>
    </div>
    
    <!-- è‡ªå®šä¹‰äº‹ä»¶ -->
    <div class="demo-box">
        <h3>è‡ªå®šä¹‰äº‹ä»¶</h3>
        <div class="code">// æœåŠ¡å™¨å‘é€:
// event: online
// data: {"count": 5}

// å®¢æˆ·ç«¯ç›‘å¬:
eventSource.addEventListener('online', function(event) {
    const data = JSON.parse(event.data);
    console.log('åœ¨çº¿äººæ•°:', data.count);
});</div>
    </div>

    <script>
        let eventSource = null;
        
        function connect() {
            const url = document.getElementById('serverUrl').value;
            const statusDiv = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            addMessage('[å®¢æˆ·ç«¯] æ­£åœ¨è¿æ¥ ' + url);
            statusDiv.textContent = 'è¿æ¥ä¸­...';
            statusDiv.className = 'status connecting';
            
            try {
                eventSource = new EventSource(url);
                
                eventSource.onopen = function() {
                    addMessage('[å®¢æˆ·ç«¯] âœ… è¿æ¥æˆåŠŸ!');
                    statusDiv.textContent = 'âœ… å·²è¿æ¥';
                    statusDiv.className = 'status connected';
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                    updateState();
                };
                
                eventSource.onmessage = function(event) {
                    addMessage('[æœåŠ¡å™¨] ' + event.data);
                };
                
                // ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶
                eventSource.addEventListener('info', function(event) {
                    addMessage('[INFO] ' + event.data);
                });
                
                eventSource.addEventListener('online', function(event) {
                    addMessage('[åœ¨çº¿] ' + event.data);
                });
                
                eventSource.onerror = function() {
                    addMessage('[å®¢æˆ·ç«¯] âŒ è¿æ¥é”™è¯¯/æ–­å¼€');
                    statusDiv.textContent = 'âŒ è¿æ¥æ–­å¼€ (å°†è‡ªåŠ¨é‡è¿...)';
                    statusDiv.className = 'status disconnected';
                    updateState();
                };
                
            } catch (error) {
                addMessage('[å®¢æˆ·ç«¯] é”™è¯¯: ' + error.message);
                statusDiv.textContent = 'âŒ è¿æ¥å¤±è´¥';
                statusDiv.className = 'status disconnected';
            }
        }
        
        function disconnect() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                
                addMessage('[å®¢æˆ·ç«¯] å·²ä¸»åŠ¨æ–­å¼€è¿æ¥');
                document.getElementById('status').textContent = 'å·²æ–­å¼€';
                document.getElementById('status').className = 'status disconnected';
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                updateState();
            }
        }
        
        function addMessage(text) {
            const messagesDiv = document.getElementById('messages');
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = 'msg';
            div.textContent = '[' + time + '] ' + text;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }
        
        function updateState() {
            const stateDiv = document.getElementById('currentState');
            if (eventSource) {
                const states = ['CONNECTING', 'OPEN', 'CLOSED'];
                stateDiv.textContent = 'å½“å‰çŠ¶æ€: ' + states[eventSource.readyState] + 
                    ' (' + eventSource.readyState + ')';
            } else {
                stateDiv.textContent = 'å½“å‰çŠ¶æ€: æœªåˆ›å»º EventSource';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ›´æ–°çŠ¶æ€
        updateState();
    </script>
</body>
</html>
