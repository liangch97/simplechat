# SYSU Chat 学习笔记（快速上手版）

> 面向同学/展示：一份把项目中的核心知识点拆解清晰的笔记，附带“在本项目里在哪里能看到/修改”与最小示例。

---

## 目录
1. 前端 / 后端 / API 分工与连接
2. 实时通信：SSE vs WebSocket
3. Java 后端要点（HTTPServer + 路由 + DAO/JDBC）
4. 鉴权与安全（Token、房间秘钥、CORS、防注入）
5. 文件与存储（路径、配额、数据库表）
6. 前端工程要点（缓存、增量历史、重连、UI 交互）
7. 部署运行与环境配置
8. 进阶/改进建议

---

## 1. 前端 / 后端 / API 分工与连接
- 概念
  - 前端：浏览器侧界面与交互，收集输入、渲染消息/文件列表，调用 API。
  - 后端：业务规则、数据落库、鉴权、文件存储、实时推送。
  - API：前后端之间约定好的“桥梁”，HTTP URL + Method + JSON 入参/出参。
- 本项目位置
  - 前端：`web/index.html`，`web/js/chat.js`（聊天），`web/js/files.js`（群文件），样式位于 `web/css/`。
  - 后端：`src/WebChatServer.java`（入口路由+SSE），`src/db/*Dao.java`（数据访问层），`src/util/*`（工具）。
  - API 示例：
    - 实时流：`GET /events?roomKey&nickname`（SSE）
    - 发消息：`POST /send`
    - 历史：`GET /api/history?roomKey&limit&offset` 或 `?since=...`
    - 文件：`/api/files/list|upload|download|delete|search|quota`（需 `Authorization: Bearer <token>`）
    - 账号：`/api/register`、`/api/login`、`/api/verify`
- 前端如何调用
  - 普通请求：`fetch(url, {method, headers, body})`
  - 实时订阅：`new EventSource('/events?...')` 监听 `message` 与自定义事件。

## 2. 实时通信：SSE vs WebSocket
- SSE（Server-Sent Events）
  - 单向：服务器 → 浏览器；基于 HTTP 长连接；浏览器原生 `EventSource`。
  - 优点：简单、自动重连、代理友好；适合通知流/聊天室推送。
  - 在项目中的端点：`/events`；实现：`WebChatServer.EventsHandler`。
- WebSocket（对比）
  - 全双工，二进制友好；需握手与心跳；适合高频双向场景（游戏/协作）。
- 选择理由
  - 本项目聊天是“前端 POST，后端推送”，SSE 足够简单稳定；若后续做复杂协同或高频双向，可再上 WS。

## 3. Java 后端要点（HTTPServer + 路由 + DAO/JDBC）
- HTTPServer：`com.sun.net.httpserver.HttpServer`
  - 创建 server，`createContext` 注册路由，`HttpHandler` 里处理 method/CORS/响应头。
- 路由与功能（见 `WebChatServer`）
  - SSE：`/events`
  - 消息：`/send`、`/api/history`、`/api/status`、`/api/ping`、`/api/disconnect`
  - 用户：`/api/register`、`/api/login`、`/api/verify`
  - 文件：`/api/files/*`；文件夹：`/api/folders/*`
  - 管理员：`/api/admin/*`
- DAO/JDBC
  - `MessageDao`：建表/迁移、写入、分页、since 增量。
  - `UserDao`：建表/迁移、注册登录、Token 校验、管理员白名单。
  - `FileDao`：文件/文件夹 CRUD、搜索、配额统计；与 `FileManager` 协同做物理存储。
  - `Db`：读取 `.env`，驱动加载，按 roomKey 选择数据库（白名单：24336064→simplechat，061318→homechat）。

## 4. 鉴权与安全
- Token 机制
  - 登录后生成：`base64(userId:username:timestamp:signature)`；签名用 `SHA-256 + SECRET_KEY`（在 `UserDao`）。
  - 有效期：24h；访问受保护接口需 `Authorization: Bearer <token>`。
- 房间秘钥与多库隔离
  - `Db.isValidRoomKey` 校验；`Db.getConnection(roomKey)` 将 roomKey 映射到对应数据库。
- 输入/内容安全
  - `MessageDao` 归一化 roomKey；`WebChatServer` 对消息做长度与基本过滤；文件名在 `FileManager`/上传处做清理。
- CORS
  - 统一在响应头设置：`Access-Control-Allow-Origin`, `Methods`, `Headers`（见 `WebChatServer.addCors`）。
- SQL 注入防护
  - 全部数据库写操作使用 `PreparedStatement`。

## 5. 文件与存储
- 物理路径
  - `storage/room_{roomKey}/user_{userId}/...`；`FileManager` 负责生成安全文件名、写入/删除/移动。
- 数据库表（见 `scripts/file-storage-schema.sql`）
  - `user_files`：文件记录（大小/类型/扩展名/下载次数/房间/文件夹路径）。
  - `user_folders`：文件夹路径与唯一约束（path+room）。
  - `user_storage_quota`：总配额/已用/文件数；本项目房间级共享 100GB（在 `FileDao.getRoomQuota`）。
- API 关键点
  - 上传：`POST /api/files/upload?roomKey&folder`，头部 `X-File-Name` + `Content-Type`，需 Bearer Token。
  - 下载：`GET /api/files/download?roomKey&fileId`（校验 roomKey 与 token）。
  - 列表/搜索/配额：`/api/files/list|search|quota`。

## 6. 前端工程要点
- 消息与历史
  - SSE 实时；本地缓存 `sysu_chat_cache_{roomKey}`；首次加载先读缓存，再用 `since` 增量；去重集合防重复。
- 重连与心跳
  - SSE 自动重连；额外 `/api/ping` 刷新在线列表/心跳超时重连；可视状态点（connected/connecting/disconnected）。
- @ 提及与通知
  - 文本高亮、音效、标题闪烁；后台时用 Notification API；在 `chat.js`。
- UI/UX
  - 主题切换、移动端侧边栏、文件上传拖放/右键菜单；图标用本地 `lucide.min.js`。

## 7. 部署运行与环境
- 环境：JDK 11+；MySQL 8.x 或 SQL Server（任选）；浏览器支持 SSE。
- 配置：项目根 `.env`
  - MySQL 示例：`DB_URL=jdbc:mysql://localhost:3306/simplechat?...`，`DB_USER=root`，`DB_PASSWORD=****`
  - SQLServer 示例：`DB_URL=jdbc:sqlserver://localhost:1433;databaseName=simplechat;encrypt=false`
- 启动：
  - Windows：`scripts/start-server.bat`
  - macOS/Linux：`scripts/start-server.sh`
  - 浏览器访问：`http://localhost:8080`
- Android（Capacitor）：目录 `android-app/`，流程 `npm install` → `npx cap sync` → Android Studio 构建 APK。

## 8. 进阶/改进建议
- 安全：类型/大小白名单、CSRF、防刷/限流、审计日志、病毒扫描。
- 可靠性：更智能的重连与心跳，或切换到 WebSocket；消息队列/缓冲以抵御瞬时峰值。
- 体验：Markdown/代码高亮、图片缩略图与懒加载、断点续传、文件分享链接+提取码（表结构已预留）。
- 架构：抽象 Service 层，增加单元测试；引入依赖注入；前后端接口契约化（OpenAPI）。

---

快速记忆句：
- 前端管“看得见和点得到”，后端管“规则、数据和推送”，API 是“桥”，SSE 是“推送的通道”。
- Token 记得带，roomKey 要校验，文件名要清理，DAO 全用 PreparedStatement。
- 先缓存再增量，先权限后操作，失败可重连，日志别忘记。
