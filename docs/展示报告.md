# SYSU Chat 项目展示与技术报告（学生版）

> 适用于课堂展示与答辩：包含项目概述、功能演示脚本、前后端与数据库实现细节、关键知识点讲解、部署与运行、FAQ 与改进建议。

---

## 1. 项目概述

- 项目名称：SYSU Chat（中山大学在线聊天室）
- 使用场景：校园内小型群聊、课程讨论、社团交流，支持图片/文件分享与基础“群网盘”功能。
- 技术栈：
  - 后端：Java 原生 HTTPServer（com.sun.net.httpserver）+ SSE（Server-Sent Events）+ REST API
  - 前端：HTML5 + CSS3 + 原生 JavaScript（`web/index.html`, `web/js/chat.js`, `web/js/files.js`）
  - 数据库：MySQL（或 SQL Server），DAO 模式（`src/db/*`）
  - 文件存储：磁盘分区按“房间 + 用户”归档（`storage/room_{key}/user_{id}`）
  - 移动端：Capacitor 封装为 Android/iOS（`android-app/`）
- 多房间与数据库映射：房间秘钥白名单与数据库绑定，见 `src/db/Db.java`
  - 24336064 -> simplechat
  - 061318 -> homechat

---

## 2. 展示内容与演示流程（讲稿）

课堂展示目标：5~8 分钟完成“功能演示 + 技术说明”。

### 2.1 演示准备
- 本机启动后端：`scripts/start-server.bat`（Windows）或 `scripts/start-server.sh`（macOS/Linux）。
- 保证 `.env` 中配置了 MySQL 或 SQL Server 连接（`DB_URL`, `DB_USER`, `DB_PASSWORD`）。
- 浏览器访问：http://localhost:8080

### 2.2 功能演示脚本
1) 登录与注册
- 在登录页输入“用户名、密码、群聊秘钥（如 24336064）”，登录。
- 如无账号，切换到注册页，输入“注册秘钥”，注册成功后返回登录。
- 登录成功后，右上角显示连接状态，左侧显示在线人数与用户列表。

2) 实时群聊（SSE）
- 在消息输入框发送文本消息；另一浏览器/设备可同步收到。
- 演示 @提及（输入 @ + 昵称），页面高亮并音效提示；后台时触发浏览器通知。
- 演示表情与表情包上传（chat 面板中的表情/表情包按钮）。

3) 文件/图片上传到聊天流
- 点击“图片/文件”按钮选择文件，后端生成消息：
  - 图片消息：[IMAGE:/uploads/xxx]
  - 文件消息：[FILE:原文件名|/uploads/xxx]
- 群成员点击即可预览或下载。

4) 群文件（内嵌网盘）
- 点击“群文件”打开网盘面板或访问 `/files.html`：
  - 显示文件夹与文件列表、存储使用条。
  - 支持上传、下载、删除、搜索、新建文件夹、重命名、移动文件。
  - 存储配额：整房间共享 100GB（可配置）。

5) 管理员功能（演示可选）
- 管理员用户名白名单见 `UserDao.ADMIN_USERNAMES`（示例：`liangch97`）。
- 登录管理员后可调用：`/api/admin/users`, `/api/admin/user/delete`, `/api/admin/user/update`, `/api/admin/user/reset-password`。

6) 多房间与隔离（讲述即可）
- 房间秘钥与数据库绑定，`Db.getConnection(roomKey)` 自动切换到对应数据库。
- 不同房间的历史消息与群文件相互隔离，保证课堂或小组间数据独立。

---

## 3. 系统架构与数据流

### 3.1 架构图（简化 ASCII）

```
[Browser/Front-end]
  index.html, chat.js, files.js
        |  REST (fetch)        |  SSE (EventSource)
        v                      v
[Java HttpServer]
  /send, /api/*             /events (SSE)
        |                        |
        v                        |
[DAO Layer]
  UserDao, MessageDao, FileDao
        |
        v
[Database]
  MySQL/SQLServer: users, messages, user_files, user_folders, user_storage_quota

[Disk Storage]
  storage/room_{key}/user_{id}/...  (物理文件)
```

### 3.2 后端端点（`src/WebChatServer.java`）
- 实时：
  - GET `/events?roomKey&nickname`：SSE 连接，推送消息与在线列表
  - POST `/send`：发送聊天消息（JSON：name, message, roomKey）
  - GET `/api/history?limit&offset&roomKey`：分页历史；支持 `since` 增量加载
  - GET `/api/status?roomKey`：在线人数、消息数、运行时间
  - GET `/api/ping?roomKey&nickname`：心跳与在线列表刷新
  - POST `/api/disconnect`：客户端主动断开，后端立刻广播在线人数
- 认证与用户：
  - POST `/api/register`：注册（username, password, nickname, secretKey）
  - POST `/api/login`：登录，返回 `token`、`nickname`、`roomKey`、`isAdmin`
  - POST `/api/verify`：验证 token 有效性
- 群文件（需 Authorization: Bearer token）：
  - POST `/api/files/upload?roomKey&folder`（请求头：`X-File-Name`、`Content-Type`）
  - GET `/api/files/list?roomKey&folder`
  - GET `/api/files/download?roomKey&fileId`
  - POST `/api/files/delete`（Body：roomKey, fileId）
  - GET `/api/files/search?roomKey&keyword`
  - GET `/api/files/quota?roomKey`（返回总/已用/剩余/百分比）
  - POST `/api/files/rename`（Body：roomKey, fileId, newName）
  - POST `/api/files/move`（Body：roomKey, fileId, newFolderPath）
- 文件夹：
  - POST `/api/folders/create`（Body：roomKey, parentPath, folderName）
  - GET `/api/folders/list?roomKey&parentPath`
  - POST `/api/folders/delete`（Body：roomKey, folderId）
  - POST `/api/folders/rename`（Body：roomKey, folderId, newName）
  - GET `/api/folders/contents?roomKey&path`（聚合）
- 管理员：
  - GET `/api/admin/users?roomKey`：用户列表
  - POST `/api/admin/user/delete`：删除用户
  - POST `/api/admin/user/update`：更新昵称/房间秘钥
  - POST `/api/admin/user/reset-password`：重置密码

### 3.3 关键后端类职责
- `WebChatServer`：路由、SSE 会话管理、CORS、JSON 简易解析、心跳清理任务；入口 main。
- `MessageDao`：建表与迁移（含 `room_key` 列）、写入、分页查询、since 增量查询。
- `UserDao`：建表与迁移、注册登录、Token 生成与校验（Base64 + 签名 + 24h 过期）、管理员白名单。
- `FileDao`：文件记录/下载计数/搜索/配额/文件夹 CRUD；按房间共享视图（不限制 user_id）。
- `FileManager`：物理存储（生成路径、写入/读取/删除/移动）、配额检查、文件名安全化、格式化大小。
- `Db`：环境变量读取（`.env` via `Env`）、驱动加载、根据房间秘钥返回对应数据库连接、白名单校验与 `databaseName` 字段替换。

---

## 4. 前端实现细节（`web/`）

### 4.1 页面与模块
- `index.html`：聊天主界面（登录覆盖层、消息区、@提及、表情/表情包、群文件面板）。
- `js/config.js`：环境切换（development/production）、统一 `getApiUrl(...)`。
- `js/chat.js`：
  - 登录/注册与 Token 验证（LocalStorage），自动恢复会话。
  - SSE 连接管理（心跳、断线重连、在线列表、去重缓存与增量历史）。
  - 图片/文件上传（聊天流内：生成 `[IMAGE]`/`[FILE]` 格式消息）。
  - @提及提醒（音效/页面闪烁/浏览器通知）。
  - Service Worker 注册与离线缓存（谨慎用于 Capacitor App）。
- `files.html` + `js/files.js`：群文件 UI；文件夹导航、拖拽上传、右键菜单、排序搜索等。

### 4.2 前端关键点
- SSE：`new EventSource(url)` 建立长连接；后端定期发送心跳与在线人数更新。
- 去重与增量历史：
  - 本地缓存键：`sysu_chat_cache_{roomKey}`；消息集合去重防止重复显示。
  - 初次加载后请求 `since` 增量，合并并限制缓存大小（最近 200 条）。
- 认证：
  - 登录成功后保存 `token` 与用户绑定 `roomKey`；所有文件 API 需带 `Authorization` 头。
- CORS：统一添加 `Access-Control-*` 响应头，方便本机调试。

---

## 5. 数据库与存储实现

### 5.1 数据库表（MySQL 示例）
- `messages`（见 `scripts/schema.sql`）：
  - `id BIGINT`，`nickname VARCHAR(64)`，`content TEXT`，`room_key VARCHAR(128)`，`created_at TIMESTAMP`
- `users`（由 `UserDao.init()` 创建）：
  - `id BIGINT`，`username UNIQUE`，`password_hash`（SHA-256 + SECRET_KEY），`nickname`，`room_key`，`created_at`，`last_login`
- `user_files`、`user_folders`、`user_storage_quota`（见 `scripts/file-storage-schema.sql`）：
  - 文件记录（大小/类型/扩展名/下载次数/房间）、文件夹唯一索引（path + room）、用户配额（总量、已用、文件数）
- `file_shares`（预留分享能力，当前前端未使用）

索引与约束：
- 常用字段索引：`idx_room_key`, `idx_created_at`，保证分页与筛选性能。
- `user_folders`：`uk_folder_path_room` 唯一键避免同房间路径重复。

### 5.2 房间与数据库映射（多租户思路）
- 在 `Db` 中白名单房间秘钥与数据库名映射；`getConnection(roomKey)` 根据白名单构造 URL。
- MySQL：自动替换 URL 中的数据库段；SQLServer：替换 `;databaseName=`。
- 迁移兼容：`MessageDao`/`UserDao` 在 init 时将旧数据的 `room_key` 修正为当前库对应秘钥。

### 5.3 物理文件存储
- 路径：`storage/room_{roomKey}/user_{userId}/...`
- 写入：后端统一生成安全文件名（时间戳前缀 + 清理特殊字符）。
- 删除/移动：同时操作数据库与物理文件；配额实时更新（增加/减少）。

---

## 6. 关键知识点讲解（学生友好版）

### 6.1 SSE vs WebSocket
- SSE（Server-Sent Events）：服务端单向推送，浏览器内置 `EventSource`，简单稳定，适合“只需服务器推送”的群聊展示。
- WebSocket：双向通信，适合复杂互动；本项目使用 REST + SSE 组合，逻辑更清晰。

### 6.2 Java 原生 HTTPServer
- `com.sun.net.httpserver.HttpServer`：无需外部框架即可快速搭建 HTTP 服务。
- 典型流程：创建 `HttpServer`、`createContext` 注册路由、实现 `HttpHandler`、调用 `sendResponseHeaders()` 与写入 `responseBody`。

### 6.3 DAO 模式与 JDBC
- DAO（Data Access Object）：把数据库读写集中在 `db/*Dao.java`，上层只调用方法，不关心 SQL 细节。
- `PreparedStatement` 防止 SQL 注入；索引提升分页/搜索性能。

### 6.4 Token 鉴权与安全
- 登录生成 Token：`base64(userId:username:timestamp:signature)`，签名为 `SHA-256(userId:username:timestamp:SECRET_KEY)` 前 8 字节。
- 有效期 24 小时；管理员白名单在服务端控制。
- CORS、文件名清理、路径遍历防护、`roomKey` 归一化（仅字母数字下划线中划线）。

### 6.5 前端工程要点
- 事件绑定与状态管理（连接状态、在线人数、历史加载、重连逻辑）。
- 本地缓存与增量同步；离线友好提示。
- UI 统一图标（Lucide）、移动端侧边栏与主题切换。

---

## 7. 部署与运行

### 7.1 环境
- JDK 11+、MySQL 8.x 或 SQL Server（任选其一）。
- `.env` 示例：
  - MySQL：`DB_URL=jdbc:mysql://localhost:3306/simplechat?...`，`DB_USER=root`，`DB_PASSWORD=****`
  - SQLServer：`DB_URL=jdbc:sqlserver://localhost:1433;databaseName=simplechat;encrypt=false`

### 7.2 启动（Windows）
- 双击或在终端运行 `scripts/start-server.bat`；编译并启动 `app.WebChatServer`；可选 Cloudflare 隧道。
- 打开浏览器访问 `http://localhost:8080`。

### 7.3 Android 打包（简述）
- 目录：`android-app/`（Capacitor + Web 资源）。
- 步骤（概览）：`npm install` -> `npx cap sync` -> Android Studio 打开 -> 构建 APK。

---

## 8. FAQ 与可能提问

- Q：为何选择 SSE 而非 WebSocket？
  - A：聊天室只需服务端推送到浏览器，SSE 简洁、原生支持、断线重连容易；REST 负责发送/文件操作。
- Q：多房间如何隔离数据？
  - A：房间秘钥白名单映射到不同数据库；DAO 层根据 `roomKey` 获取对应连接，消息/文件按房间隔离。
- Q：如何防止恶意上传？
  - A：文件名清理、MIME 检查（可扩展）、按用户与房间分区存储；后续可加入大小/类型白名单与病毒扫描。
- Q：数据库迁移如何做？
  - A：`MessageDao.init()`/`UserDao.init()` 里做列与数据修复；另有 `scripts/` 提供建表与迁移脚本。

---

## 9. 改进建议（可加分）

- 安全：CSRF 防护、文件类型与大小限制、统一异常处理与审计日志。
- 稳定：心跳/重连策略更智能，SSE 转 WebSocket 可选；消息队列支持离线堆叠。
- 体验：Markdown 支持、图片缩略图、断点续传、文件分享链接与提取码（已有表结构）。
- 架构：抽象 Service 层；引入依赖注入；按接口拆分类，便于单元测试与维护。

---

## 10. 结语（展示收尾）

本项目坚持“简单可用”的原则：以原生 Java HTTPServer + SSE 快速实现一个校园聊天室与轻量网盘，代码清晰、依赖少、部署简易；同时具备多房间隔离、Token 鉴权、离线缓存与移动端封装能力。欢迎老师与同学提出建议。

---

附：主要文件路径索引
- 后端入口：`src/WebChatServer.java`
- DAO：`src/db/MessageDao.java`, `src/db/UserDao.java`, `src/db/FileDao.java`
- 工具：`src/util/FileManager.java`, `src/db/Db.java`, `src/util/Env.java`
- 前端页面：`web/index.html`, `web/files.html`
- 前端脚本：`web/js/chat.js`, `web/js/config.js`, `web/js/files.js`
- 脚本：`scripts/schema.sql`, `scripts/file-storage-schema.sql`, `scripts/start-server.bat`

---

## 附录 A：前端 / 后端 / API 速懂（怎么连、为什么分）

### A.1 概念是什么？

- 前端（Front-end）：运行在浏览器（或 App WebView）里的界面与交互代码，负责“看得见、点得到”的一切。
  - 本项目对应：`web/index.html`、`web/js/chat.js`（聊天）、`web/js/files.js`（群文件）、样式与图标等。
  - 典型工作：收集用户输入、渲染消息列表、调用后端 API、展示上传/下载进度等。

- 后端（Back-end）：运行在服务器的程序，负责业务规则、数据持久化、鉴权、文件存储与消息推送。
  - 本项目对应：`src/WebChatServer.java`（HTTP 路由+SSE 推送）、`src/db/*Dao.java`（数据访问）、`src/util/*`（工具）。
  - 典型工作：校验权限、落库、读写磁盘、广播消息、提供安全的接口。

- API（Application Programming Interface）：后端对外暴露的“规范化入口”，通常是 HTTP URL + Method + JSON 入参/出参。
  - 本项目的 API 例子：
    - 实时流：`GET /events?roomKey&nickname`（SSE 服务端推送）
    - 消息写入：`POST /send`（发送一条消息）
    - 历史分页：`GET /api/history?roomKey&limit&offset` 或 `?since=...`
    - 文件：`/api/files/list|upload|download|delete|search|quota`（需 `Authorization: Bearer <token>`）
    - 账号：`/api/register`、`/api/login`、`/api/verify`

### A.2 他们怎么连接？（本项目的两种通道）

1) 拉取/提交（Request → Response）
- 前端用 `fetch()` 调后端 REST API：

```js
// 发送消息（简化示例）
fetch(CONFIG.getApiUrl('sendEndpoint'), {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ name: nickname, message: text, roomKey })
});
```

2) 实时推送（Server → Client）
- 前端用浏览器原生 `EventSource` 订阅 SSE 流，后端持续写入 `text/event-stream`：

```js
const es = new EventSource(CONFIG.getApiUrl('eventsEndpoint') + `?roomKey=${roomKey}&nickname=${nickname}`);
es.onmessage = (e) => handleIncoming(e.data);     // 普通消息
es.addEventListener('online', (e) => updateUsers(JSON.parse(e.data))); // 在线人数/列表
```

后端对应实现（见 `WebChatServer`）：
- SSE 端点：设置 `Content-Type: text/event-stream`、`Cache-Control: no-cache`、`Connection: keep-alive`，循环写入 `data: ...\n\n`。
- REST 端点：解析 JSON、校验参数/权限、调用 DAO 写库/读库，返回 JSON。
- 文件端点：校验 `Authorization` Token 与 `roomKey`，统一磁盘与数据库操作。

鉴权要点：
- 登录成功后，后端签发 `token`（Base64+签名，24h 有效）。
- 前端之后访问受保护接口时，带上 `Authorization: Bearer <token>`；后端用 `UserDao.validateToken` 校验。

### A.3 为什么要前后端分离？

- 职责单一、可维护：界面与交互（前端）和业务与数据（后端）各自独立演进。
- 团队协作：前端/后端可以并行开发，约定好 API 即可 Mock 联调。
- 多端复用：一个后端 API 可同时服务网页、Android App（`android-app/`）、脚本或其他系统。
- 安全合规：数据库凭据、敏感逻辑只在后端；前端拿不到密钥，客户端被反编译也不会泄漏数据库。
- 部署灵活：静态资源可走 CDN，后端按负载独立扩缩容；SSE/REST 能通过反向代理统一接入。
- 性能与稳定：后端可加缓存/限流/审计，前端可做离线缓存与增量加载（本项目聊天历史就用了）。

### A.4 本项目的最小“数据流”复述

```
[浏览器 前端]
  1) POST /login -> 拿到 token & roomKey
  2) EventSource /events?roomKey&nickname  (订阅推送)
  3) POST /send  (发送消息)
  4) GET  /api/history?roomKey&...  (翻历史/增量)
  5) 文件 API（需 Authorization）
        |
        v
[Java 后端 WebChatServer]
  - 校验参数/鉴权 -> 调用 DAO -> 数据库
  - SSE 广播消息/在线列表
        |
        v
[数据库/磁盘]
  - messages/users/user_files 等表
  - storage/room_{key}/user_{id}/ 实体文件
```

用一句话概括：前端“展示与交互”，后端“规则与数据”，API 是“协议与桥梁”，SSE 则是“实时推送的通道”。

